name: Deploy MultiPost Markdown Editor

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨ main åˆ†æ”¯æ‰“äº† v* æ ¼å¼çš„ tag æ—¶è§¦å‘
    branches:
      - main  # é™åˆ¶åªèƒ½ä» main åˆ†æ”¯è§¦å‘

# ç¡®ä¿ GitHub Actions ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…å¹¶å‘éƒ¨ç½²å†²çª
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºéªŒè¯åˆ†æ”¯

      - name: Check Skip CI
        run: |
          if echo "${{ github.event.head_commit.message }}" | grep -q "\[skip ci\]\|\[ci skip\]\|noci"; then
            echo "â­ï¸ è·³è¿‡æ„å»º: commit message åŒ…å«è·³è¿‡æ ‡è®°"
            exit 78
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Docker Registry (Hangzhou)
        uses: docker/login-action@v3
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.ALIYUN_DOCKER_USERNAME }}
          password: ${{ secrets.ALIYUN_DOCKER_PASSWORD }}

      - name: Setup docker-compose
        uses: KengoTODA/actions-setup-docker-compose@v1
        with:
          version: '2.14.2'

      - name: Build and Push Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: registry.cn-hangzhou.aliyuncs.com/famawang-ns/multipost-webapp:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to JDCloud Production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.JDCLOUD_HOST }}
          username: ${{ secrets.JDCLOUD_USERNAME }}
          port: ${{ secrets.JDCLOUD_PORT }}
          key: ${{ secrets.JDCLOUD_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°äº¬ä¸œäº‘æœåŠ¡å™¨..."
            
            # ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
            docker login --username=${{ secrets.ALIYUN_DOCKER_USERNAME }} \
              --password=${{ secrets.ALIYUN_DOCKER_PASSWORD }} \
              registry.cn-hangzhou.aliyuncs.com
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            docker pull registry.cn-hangzhou.aliyuncs.com/famawang-ns/multipost-webapp:latest
            
            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            docker stop multipost-webapp || true
            docker rm multipost-webapp || true
            
            # å¯åŠ¨æ–°å®¹å™¨
            docker run -d \
              --name multipost-webapp \
              --restart unless-stopped \
              -p 8080:80 \
              registry.cn-hangzhou.aliyuncs.com/famawang-ns/multipost-webapp:latest
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸ“ è®¿é—®åœ°å€: http://$(curl -s ifconfig.me):8080"