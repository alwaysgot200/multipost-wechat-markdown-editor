# 快速开始

<cite>
**本文档中引用的文件**  
- [package.json](file://package.json)
- [vite.config.ts](file://apps/web/vite.config.ts)
- [wxt.config.ts](file://apps/web/wxt.config.ts)
- [Dockerfile](file://docker/Dockerfile)
- [docker-compose-build.yml](file://docker/docker-compose-build.yml)
- [md-cli/package.json](file://packages/md-cli/package.json)
- [md-cli/index.js](file://packages/md-cli/index.js)
- [md-cli/server.js](file://packages/md-cli/server.js)
- [md-cli/util.js](file://packages/md-cli/util.js)
- [build-extension.ts](file://apps/web/src/modules/build-extension.ts)
- [apps/vscode/package.json](file://apps/vscode/package.json)
- [netlify.toml](file://apps/web/netlify.toml)
- [Dockerfile.standalone](file://docker/latest/Dockerfile.standalone)
- [Dockerfile.nginx](file://docker/latest/Dockerfile.nginx)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [通过Vite启动Web开发服务器](#通过vite启动web开发服务器)
4. [使用Docker进行容器化部署](#使用docker进行容器化部署)
5. [运行md-cli命令行工具](#运行md-cli命令行工具)
6. [构建并加载浏览器扩展](#构建并加载浏览器扩展)
7. [常见问题排查](#常见问题排查)
8. [验证服务是否成功启动](#验证服务是否成功启动)

## 简介

本指南旨在帮助新用户和开发者在不同环境下快速运行 **MultiPost - Markdown 编辑器** 项目。该项目基于 [doocs/md](https://github.com/doocs/md) 改造，支持微信图文即时渲染，并可通过 [MultiPost 浏览器扩展](https://github.com/leaper-one/MultiPost-Extension) 实现一键同步发布到知乎、微博、小红书等多个平台。

本文档涵盖四种主要使用方式：
1. 通过 Vite 启动本地 Web 应用开发服务器
2. 使用 Docker 进行容器化部署（包括 standalone、nginx 等模式）
3. 运行 `md-cli` 命令行工具实现本地服务启动
4. 构建并加载浏览器扩展（通过 WXT 框架）

所有操作均基于项目根目录下的 `package.json` 脚本入口，并结合关键配置文件说明其作用。

**Section sources**
- [README.md](file://README.md#L1-L92)
- [package.json](file://package.json#L1-L69)

## 环境准备

在开始之前，请确保已安装以下依赖：

- **Node.js**: 版本 >= 22.16.0（由 `package.json` 中的 `engines` 字段指定）
- **pnpm**: 推荐使用 pnpm 包管理器（项目使用 `pnpm-workspace.yaml` 管理多包）
- **Docker**: 若选择容器化部署，需安装 Docker 和 Docker Compose
- **浏览器**: 推荐使用 Chrome 浏览器进行开发和测试

可通过以下命令检查版本：

```bash
node --version
pnpm --version
docker --version
docker-compose --version
```

安装 pnpm（如未安装）：

```bash
npm install -g pnpm
```

克隆项目后进入根目录并安装依赖：

```bash
git clone https://github.com/leaper-one/multipost-wechat-markdown-editor.git
cd multipost-wechat-markdown-editor
pnpm install
```

**Section sources**
- [package.json](file://package.json#L16-L17)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)

## 通过Vite启动Web开发服务器

### 启动命令

使用 Vite 启动本地开发服务器是最直接的开发方式。项目提供了标准化的脚本入口：

```bash
# 方式1：使用根目录脚本（推荐）
npm start
# 或
pnpm start

# 方式2：直接进入 web 子项目启动
cd apps/web
pnpm dev
```

上述命令等价于执行 `pnpm web dev`，其中 `web` 是根 `package.json` 中定义的别名脚本，指向 `@md/web` 包。

### 配置说明：vite.config.ts

位于 `apps/web/vite.config.ts` 的配置文件定义了开发服务器的核心参数：

- **base**: 根据环境变量 `SERVER_ENV` 动态设置基础路径（如 `/md/`、`./` 或 `/`）
- **plugins**: 包含 Vue 插件、Tailwind CSS、Vue DevTools、Node Polyfills 等
- **resolve.alias**: 设置 `@` 别名为 `src` 目录，便于模块导入
- **build.rollupOptions**: 自定义打包分块策略，将 `katex`、`highlight.js`、`codemirror` 等独立打包
- **envPrefix**: 环境变量前缀为 `VITE_` 和 `CF_`，确保安全暴露至客户端

开发服务器默认监听 `http://localhost:5173`。

### 构建生产版本

```bash
# 构建用于 Netlify 部署的版本
pnpm run build:h5-netlify

# 构建标准版本（输出到 /md 子目录）
pnpm run build
```

构建产物位于 `apps/web/dist` 目录。

**Section sources**
- [package.json](file://package.json#L19-L20)
- [vite.config.ts](file://apps/web/vite.config.ts#L1-L92)
- [netlify.toml](file://apps/web/netlify.toml#L1-L10)

## 使用Docker进行容器化部署

项目提供多种 Docker 部署模式，适用于不同场景。

### 1. 使用预构建镜像（推荐）

最简单的方式是拉取并运行官方镜像：

```bash
docker run -d -p 8080:80 doocs/md:latest
```

容器启动后，访问 `http://localhost:8080` 即可使用。

### 2. 使用 docker-compose 构建并运行

项目提供 `docker-compose-build.yml` 文件，支持从源码构建并运行：

```bash
# 构建并启动服务
docker-compose -f docker/docker-compose-build.yml up --build
```

该配置会基于 `docker/Dockerfile` 构建镜像，并映射端口 8080。

### 3. 多模式 Dockerfile 支持

项目支持三种容器化模式，位于 `docker/latest/` 目录：

#### (1) Standalone 模式（Go 服务器）

使用 Go 编写的轻量级 HTTP 服务器：

```bash
# 构建 standalone 镜像
docker build -f docker/latest/Dockerfile.standalone -t multipost-md:standalone .

# 运行
docker run -d -p 8080:80 multipost-md:standalone
```

此模式使用 `server/main.go` 作为后端服务，适合需要高性能静态服务的场景。

#### (2) Nginx 模式

使用 Nginx 作为反向代理服务器：

```bash
# 构建 nginx 镜像
docker build -f docker/latest/Dockerfile.nginx -t multipost-md:nginx .

# 运行
docker run -d -p 8080:80 multipost-md:nginx
```

Nginx 配置文件位于 `docker/nginx.conf`，已优化静态资源服务。

#### (3) Static 模式

仅构建静态资源，可用于 CDN 或对象存储部署。

### 构建脚本支持

项目提供 Shell 脚本自动化构建流程：

- `scripts/build-standalone.sh`: 构建 standalone 模式镜像
- `scripts/build-nginx.sh`: 构建 nginx 模式镜像
- `scripts/build-static.sh`: 构建静态资源

**Section sources**
- [Dockerfile](file://docker/Dockerfile#L1-L39)
- [docker-compose-build.yml](file://docker/docker-compose-build.yml#L1-L8)
- [Dockerfile.standalone](file://docker/latest/Dockerfile.standalone#L1-L23)
- [Dockerfile.nginx](file://docker/latest/Dockerfile.nginx#L1-L7)
- [scripts/build-standalone.sh](file://scripts/build-standalone.sh#L1-L25)

## 运行md-cli命令行工具

`md-cli` 是一个 npm CLI 工具，允许用户快速启动本地服务而无需手动构建。

### 安装与启动

```bash
# 全局安装 CLI 工具
npm i -g @doocs/md-cli

# 启动服务（默认端口 8800）
md-cli

# 指定端口启动
md-cli port=8899
```

服务启动后，访问 `http://127.0.0.1:8800/md/` 即可使用。

### 源码运行方式

若希望从源码运行 CLI：

```bash
# 进入 md-cli 包目录
cd packages/md-cli

# 安装依赖
pnpm install

# 启动开发模式（使用 nodemon 监听变化）
pnpm run dev
```

### CLI 参数支持

`md-cli` 支持以下命令行参数：

- `port`: 指定服务端口，默认 8800
- `spaceId`: DCloud 服务空间 ID（用于云存储）
- `clientSecret`: DCloud 客户端密钥

当提供 `spaceId` 和 `clientSecret` 时，图片上传将自动同步至云端。

### 实现原理

`md-cli` 基于 Express 框架实现：

- `index.js`: 主入口，解析参数并启动服务器
- `server.js`: 创建 Express 应用，处理文件上传和代理请求
- `util.js`: 提供参数解析、颜色输出、DCloud 云存储上传等功能

服务器监听 `127.0.0.1`，确保仅本地可访问，保障安全性。

**Section sources**
- [packages/md-cli/package.json](file://packages/md-cli/package.json#L1-L43)
- [packages/md-cli/index.js](file://packages/md-cli/index.js#L1-L58)
- [packages/md-cli/server.js](file://packages/md-cli/server.js#L1-L105)
- [packages/md-cli/util.js](file://packages/md-cli/util.js#L1-L170)

## 构建并加载浏览器扩展

项目使用 **WXT** 框架构建浏览器扩展，支持 Chrome 和 Firefox。

### wxt.config.ts 配置说明

位于 `apps/web/wxt.config.ts` 的配置文件定义了扩展的核心行为：

- **manifest**: 生成 `manifest.json`，包含权限、图标、侧边栏配置等
- **permissions**: 请求 `storage`、`activeTab`、`sidePanel` 等权限
- **host_permissions**: 允许访问 GitHub、Gitee、微信等域名
- **side_panel**: 配置 Chrome 侧边栏入口
- **sidebar_action**: 配置 Firefox 侧边栏入口
- **commands**: 定义快捷键 `_execute_sidebar_action`（默认 Ctrl+Shift+Y）
- **vite**: 继承 `vite.config.ts` 配置，但移除 `vite-plugin-Radar` 等不兼容插件

### 构建扩展

```bash
# 构建扩展（输出到 dist/extension）
pnpm --filter @md/web run build:extension

# 开发模式（热重载）
pnpm --filter @md/web run dev:extension
```

构建产物位于 `apps/web/dist/extension` 目录。

### 加载扩展到浏览器

#### Chrome 浏览器

1. 打开 `chrome://extensions/`
2. 开启“开发者模式”
3. 点击“加载已解压的扩展程序”
4. 选择 `apps/web/dist/extension` 目录

#### Firefox 浏览器

1. 打开 `about:debugging#/runtime/this-firefox`
2. 点击“临时加载附加组件”
3. 选择 `apps/web/dist/extension/manifest.json`

### 扩展功能

- 侧边栏集成：可在任意网页右侧打开 Markdown 编辑器
- 内容注入：支持在 GitHub、微信公众号等页面直接编辑
- 快捷键触发：使用 `Ctrl+Shift+Y` 快速打开编辑器
- 本地存储：自动保存草稿至浏览器 `storage` API

**Section sources**
- [wxt.config.ts](file://apps/web/wxt.config.ts#L1-L102)
- [build-extension.ts](file://apps/web/src/modules/build-extension.ts#L1-L264)
- [web-ext.config.ts.example](file://apps/web/web-ext.config.ts.example#L1-L10)

## 常见问题排查

### 1. 端口冲突

**现象**：启动服务时报错 `EADDRINUSE`（端口被占用）

**解决方案**：
- Vite 开发服务器：默认使用 5173 端口，可按提示选择其他端口
- md-cli：使用 `md-cli port=8899` 指定端口
- Docker：修改 `-p` 参数映射不同主机端口，如 `-p 8090:80`

### 2. 依赖安装失败

**现象**：`pnpm install` 报错，无法下载包

**解决方案**：
- 检查网络连接，尝试切换镜像源：
  ```bash
  pnpm config set registry https://registry.npmmirror.com
  ```
- 清除缓存后重试：
  ```bash
  pnpm store prune
  pnpm install
  ```

### 3. 构建失败（Node.js 版本不匹配）

**现象**：提示 Node.js 版本不满足要求

**解决方案**：
- 检查当前版本：`node --version`
- 使用 nvm 切换版本：
  ```bash
  nvm install 22.16.0
  nvm use 22.16.0
  ```

### 4. Docker 构建失败

**现象**：`docker build` 报错，依赖下载失败

**解决方案**：
- 检查 Docker 网络，尝试配置国内镜像加速
- 在 `Dockerfile` 中替换 npm 源：
  ```dockerfile
  RUN npm config set registry https://registry.npmmirror.com
  ```

### 5. 扩展加载失败

**现象**：Chrome 提示“清单文件缺失或不可读”

**解决方案**：
- 确保已执行 `pnpm run build:extension`
- 检查 `dist/extension` 目录是否存在 `manifest.json`
- 确认构建过程中无错误

**Section sources**
- [package.json](file://package.json#L16-L17)
- [vite.config.ts](file://apps/web/vite.config.ts#L24-L27)
- [md-cli/index.js](file://packages/md-cli/index.js#L20-L23)
- [Dockerfile](file://docker/Dockerfile#L13)

## 验证服务是否成功启动

### 1. Vite 开发服务器

- 访问 `http://localhost:5173`
- 页面应正常加载，无控制台错误
- 可编辑 Markdown 内容并实时预览

### 2. Docker 容器

```bash
# 查看容器运行状态
docker ps

# 查看日志
docker logs <container_id>

# 验证服务响应
curl -I http://localhost:8080
```

预期返回 HTTP 200 状态码。

### 3. md-cli 服务

- 访问 `http://127.0.0.1:8800/md/`
- 控制台应输出：
  ```
  服务已启动:
  打开链接 http://127.0.0.1:8800 即刻使用吧~
  ```

### 4. 浏览器扩展

- 在 Chrome 扩展页面确认“MD 公众号编辑器”已启用
- 使用快捷键 `Ctrl+Shift+Y` 打开侧边栏
- 在任意网页验证侧边栏能否正常弹出