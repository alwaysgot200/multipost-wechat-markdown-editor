# 多图床支持

<cite>
**本文档引用文件**  
- [api.ts](file://packages/shared/src/configs/api.ts)
- [storage.ts](file://apps/web/src/utils/storage.ts)
- [file.ts](file://apps/web/src/utils/file.ts)
- [UploadImgDialog.vue](file://apps/web/src/components/editor/UploadImgDialog.vue)
- [export.ts](file://apps/web/src/stores/export.ts)
</cite>

## 目录
1. [简介](#简介)
2. [主流图床服务集成](#主流图床服务集成)
3. [认证机制与配置策略](#认证机制与配置策略)
4. [统一上传接口抽象层](#统一上传接口抽象层)
5. [图片导出与上传协同机制](#图片导出与上传协同机制)
6. [性能优化建议](#性能优化建议)
7. [扩展新图床服务指南](#扩展新图床服务指南)

## 简介
本技术文档详细阐述了多图床支持系统的架构设计与实现机制。系统通过统一的抽象层集成了GitHub、Gitee、七牛云、腾讯云COS、AWS S3等主流图床服务，实现了灵活的图片上传与管理功能。文档重点分析了配置结构、认证机制、仓库管理、上传流程及扩展性设计，为开发者提供全面的技术参考。

## 主流图床服务集成
系统支持多种主流图床服务，包括GitHub、Gitee、七牛云、腾讯云COS、阿里云OSS、Cloudflare R2、又拍云（Upyun）等。每种图床服务通过独立的上传函数实现，由统一的`fileUpload`函数根据当前配置进行路由调度。

图床服务的配置信息存储在浏览器的`localStorage`中，通过`store`实例进行读写操作。用户可在UI界面中选择目标图床并配置相应参数，如仓库名、分支、访问令牌等。

```mermaid
graph TD
A[用户选择图床] --> B{判断图床类型}
B --> |GitHub| C[调用ghFileUpload]
B --> |Gitee| D[调用giteeUpload]
B --> |七牛云| E[调用qiniuUpload]
B --> |腾讯云COS| F[调用txCOSFileUpload]
B --> |阿里云OSS| G[调用aliOSSFileUpload]
B --> |R2| H[调用r2Upload]
B --> |又拍云| I[调用upyunUpload]
C --> J[返回CDN加速URL]
D --> J
E --> J
F --> J
G --> J
H --> J
I --> J
J --> K[插入Markdown]
```

**图床来源**  
- [file.ts](file://apps/web/src/utils/file.ts#L604-L641)
- [UploadImgDialog.vue](file://apps/web/src/components/editor/UploadImgDialog.vue#L261-L308)

## 认证机制与配置策略
### 认证机制
系统采用基于访问令牌（accessToken）的认证机制。对于GitHub和Gitee，使用个人访问令牌（Personal Access Token）进行API调用认证；对于云存储服务（如七牛云、腾讯云COS、阿里云OSS），使用密钥对（AccessKey/SecretKey）进行签名认证。

在`api.ts`中定义了GitHub和Gitee的默认配置，包含多个访问令牌组成的轮询列表（`accessTokenList`），用于分散请求压力和避免单个令牌配额耗尽。

```typescript
export const githubConfig = {
  username: `bucketio`,
  repoList: Array.from({ length: 20 }, (_, i) => `img${i}`),
  branch: `main`,
  accessTokenList: [
    `ghp_sqQg5y7XC7Fy8XdoocsmdVEYRiRiTZPvbwzTL4MRjQc`,
    // ... 其他令牌
  ],
}
```

### 仓库与分支管理
系统支持动态分配仓库和分支。通过`repoList`数组定义可用的仓库列表，上传时可轮询选择或根据策略分配。分支默认为`main`，可在配置中修改。

用户可通过UI界面自定义仓库、分支和访问令牌，配置信息持久化存储在本地。

**配置来源**  
- [api.ts](file://packages/shared/src/configs/api.ts#L1-L47)
- [UploadImgDialog.vue](file://apps/web/src/components/editor/UploadImgDialog.vue#L21-L25)

## 统一上传接口抽象层
### 存储引擎抽象
系统通过`StorageManager`类实现了统一的存储抽象层，支持本地存储（`LocalStorageEngine`）和远程RESTful API存储（`RestfulStorageEngine`）。该抽象层提供异步化的`get`、`set`、`remove`等方法，屏蔽底层存储差异。

```mermaid
classDiagram
class StorageEngine {
<<interface>>
+get(key : string) : Promise<string | null>
+set(key : string, value : string) : Promise<void>
+remove(key : string) : Promise<void>
+has(key : string) : Promise<boolean>
+clear() : Promise<void>
+keys() : Promise<string[]>
}
class LocalStorageEngine {
+get(key : string) : Promise<string | null>
+set(key : string, value : string) : Promise<void>
+remove(key : string) : Promise<void>
+has(key : string) : Promise<boolean>
+clear() : Promise<void>
+keys() : Promise<string[]>
}
class RestfulStorageEngine {
+get(key : string) : Promise<string | null>
+set(key : string, value : string) : Promise<void>
+remove(key : string) : Promise<void>
+has(key : string) : Promise<boolean>
+clear() : Promise<void>
+keys() : Promise<string[]>
}
StorageEngine <|-- LocalStorageEngine
StorageEngine <|-- RestfulStorageEngine
StorageManager --> StorageEngine : "使用"
```

**图床来源**  
- [storage.ts](file://apps/web/src/utils/storage.ts#L12-L150)

### 上传流程抽象
`fileUpload`函数作为统一入口，根据当前图床配置调用相应的上传函数。各图床上传函数封装了SDK差异，返回标准化的图片URL。

例如，七牛云上传使用`qiniu-js` SDK生成上传令牌并上传文件；腾讯云COS使用`cos-js-sdk-v5` SDK进行对象存储操作；阿里云OSS使用`ali-oss` SDK完成上传。

```mermaid
sequenceDiagram
participant UI as 用户界面
participant Upload as fileUpload
participant Store as 存储引擎
participant GitHub as GitHub上传
participant Qiniu as 七牛云上传
UI->>Upload : 上传图片
Upload->>Store : 获取imgHost配置
Store-->>Upload : 返回图床类型
alt GitHub图床
Upload->>GitHub : 调用ghFileUpload
GitHub->>GitHub : 生成上传URL
GitHub-->>Upload : 返回图片URL
else 七牛云图床
Upload->>Qiniu : 调用qiniuUpload
Qiniu->>Qiniu : 生成上传令牌
Qiniu-->>Upload : 返回图片URL
end
Upload-->>UI : 插入Markdown语法
```

**上传来源**  
- [file.ts](file://apps/web/src/utils/file.ts#L78-L458)
- [storage.ts](file://apps/web/src/utils/storage.ts#L362)

## 图片导出与上传协同机制
### 导出功能集成
`export.ts`中的`useExportStore`负责处理各种导出功能，包括HTML、PDF、Markdown和图片导出。图片导出功能与图床上传协同工作，确保导出内容中的图片链接有效。

当用户导出为HTML或PDF时，系统会自动处理图片资源，确保引用的图片可通过CDN访问。

### 错误重试与并发控制
系统在上传过程中实现了基础的错误处理机制。各上传函数通过Promise封装，上传失败时返回reject，可在调用层进行重试逻辑处理。

并发控制通过UI层的上传进度反馈实现。`UploadImgDialog.vue`中使用`progressValue`变量显示上传进度，并通过`beforeImageUpload`钩子函数校验图床配置有效性。

```mermaid
flowchart TD
A[用户拖拽图片] --> B[调用beforeImageUpload]
B --> C{图床配置有效?}
C --> |是| D[显示上传进度]
C --> |否| E[提示配置图床]
D --> F[调用fileUpload]
F --> G{上传成功?}
G --> |是| H[插入Markdown]
G --> |否| I[显示错误信息]
H --> J[重置进度条]
I --> J
```

**导出来源**  
- [export.ts](file://apps/web/src/stores/export.ts#L1-L100)
- [UploadImgDialog.vue](file://apps/web/src/components/editor/UploadImgDialog.vue#L322-L381)

## 性能优化建议
### CDN加速
系统默认对GitHub图床使用`fastly.jsdelivr.net` CDN加速，将原始`raw.githubusercontent.com`链接替换为CDN链接，显著提升图片加载速度。

```typescript
const githubResourceUrl = `raw.githubusercontent.com/${username}/${repo}/${branch}/`
const cdnResourceUrl = `fastly.jsdelivr.net/gh/${username}/${repo}@${branch}/`
return res.content.download_url.replace(githubResourceUrl, cdnResourceUrl)
```

### 缓存策略
利用浏览器`localStorage`缓存图床配置，减少重复配置。对于频繁访问的资源（如样式文件），可通过CDN实现HTTP缓存。

### 带宽优化
- 启用图片压缩：用户可选择开启图片压缩功能，减小上传文件体积
- 合理选择存储路径：通过`path`参数指定存储目录，便于资源管理
- 使用合适的CDN：优先选择地理位置近的CDN节点，降低延迟

## 扩展新图床服务指南
### 认证协议适配
1. 分析目标图床的认证方式（OAuth、AccessKey、Token等）
2. 在`UploadImgDialog.vue`中添加配置表单，收集认证所需参数
3. 实现认证逻辑，如生成签名、获取访问令牌等

### API接口封装
1. 在`file.ts`中创建新的上传函数，如`customUpload`
2. 封装SDK调用，处理上传流程和错误
3. 返回标准化的图片URL

### 错误码映射
建立统一的错误处理机制，将不同图床的错误码映射为用户友好的提示信息。例如：
- 网络错误：提示“网络连接失败，请检查网络”
- 认证失败：提示“认证信息无效，请检查配置”
- 配额超限：提示“上传配额已满，请更换令牌或仓库”

通过以上步骤，可轻松扩展支持新的图床服务，保持系统架构的灵活性和可维护性。

**扩展来源**  
- [file.ts](file://apps/web/src/utils/file.ts#L570-L602)
- [UploadImgDialog.vue](file://apps/web/src/components/editor/UploadImgDialog.vue#L256-L259)
- [docs/custom-upload.md](file://docs/custom-upload.md#L7-L46)